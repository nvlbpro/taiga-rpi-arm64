name: Build, Test, and Push Taiga ARM64 Images

on:
  workflow_dispatch:

env:
  REPO: nvlbpro/taiga-rpi-arm64
  IMAGES: back async front events protected
  DOCKER_PLATFORM: linux/arm64

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ env.DOCKER_PLATFORM }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone upstream Taiga repos
        run: |
          git clone --depth 1 --branch main https://github.com/taigaio/taiga-back.git
          git clone --depth 1 --branch main https://github.com/taigaio/taiga-front.git
          git clone --depth 1 --branch main https://github.com/taigaio/taiga-events.git
          git clone --depth 1 --branch main https://github.com/taigaio/taiga-protected.git

      - name: Build back & async images
        run: |
          for img in back async; do
            docker buildx build \
              --platform $DOCKER_PLATFORM \
              -t $REPO:${img}-latest \
              -f docker/taiga-back/Dockerfile \
              taiga-back/ \
              --load
          done

      - name: Build front image
        run: |
          docker buildx build \
            --platform $DOCKER_PLATFORM \
            -t $REPO:front-latest \
            -f docker/Dockerfile \
            taiga-front/ \
            --load

      - name: Build events image
        run: |
          docker buildx build \
            --platform $DOCKER_PLATFORM \
            -t $REPO:events-latest \
            -f docker/Dockerfile \
            taiga-events/ \
            --load

      - name: Build protected image
        run: |
          docker buildx build \
            --platform $DOCKER_PLATFORM \
            -t $REPO:protected-latest \
            -f docker/taiga-protected/Dockerfile \
            taiga-protected/ \
            --load

      - name: Create .env for testing
        run: |
          cat <<EOF > .env
          TAIGA_SCHEME=http
          TAIGA_DOMAIN=localhost:9000
          SUBPATH=""
          WEBSOCKETS_SCHEME=ws
          SECRET_KEY="test-secret-key"
          POSTGRES_USER=taiga
          POSTGRES_PASSWORD=taiga
          EMAIL_BACKEND=console
          EMAIL_HOST=smtp.example.com
          EMAIL_PORT=587
          EMAIL_HOST_USER=user
          EMAIL_HOST_PASSWORD=password
          EMAIL_DEFAULT_FROM=taiga@example.com
          EMAIL_USE_TLS=True
          EMAIL_USE_SSL=False
          RABBITMQ_USER=taiga
          RABBITMQ_PASS=taiga
          RABBITMQ_VHOST=taiga
          RABBITMQ_ERLANG_COOKIE=secret-erlang-cookie
          ATTACHMENTS_MAX_AGE=360
          ENABLE_TELEMETRY=False
          EOF

      - name: Launch test database
        run: |
          docker compose -f docker-compose.yml up -d taiga-db
          sleep 10
          docker compose -f docker-compose.yml ps taiga-db | grep "healthy" || exit 1

      - name: Apply migrations
        run: |
          chmod +x taiga-manage.sh
          ./taiga-manage.sh migrate

      - name: Test full Taiga stack
        run: |
          chmod +x launch-taiga.sh
          ./launch-taiga.sh
          sleep 15
          # Check all containers running
          COUNT=$(docker ps --format '{{.Names}}' | grep -E 'taiga-rpi-arm64-taiga-(db|back|async|front|events|protected|gateway|async-rabbitmq|events-rabbitmq)-1' | wc -l)
          if [ "$COUNT" -ne 9 ]; then
            echo "Error: Not all containers are running"
            docker compose -f docker-compose.yml logs
            exit 1
          fi
          # Check HTTP endpoint
          curl -fsSL http://localhost:9000/ || (echo "Error: Taiga HTTP endpoint not reachable" && exit 1)
          # Optional: check version inside back container
          docker exec taiga-rpi-arm64-taiga-back-1 cat /taiga-back/taiga/__init__.py | grep __version__ || echo "Warning: version not found"

      - name: Retag images to stable
        run: |
          for img in $IMAGES; do
            docker tag $REPO:${img}-latest $REPO:${img}-stable
          done

      - name: Push all images to Docker Hub
        run: |
          for img in $IMAGES; do
            docker push $REPO:${img}-latest
            docker push $REPO:${img}-stable
          done
