name: Build, Test and Push Taiga ARM64 Images

on:
  workflow_dispatch:

env:
  VERSION: 6.9.0
  REPO: nvlbpro/taiga-rpi-arm64

jobs:
  build-taiga-back-and-async:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone taiga-back ${{ env.VERSION }}
        run: git clone --depth 1 --branch $VERSION https://github.com/taigaio/taiga-back.git

      - name: Build & Push taiga-back
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -t $REPO:back-${VERSION}-ci \
            -f docker/taiga-back/Dockerfile \
            taiga-back/ \
            --push

      - name: Build & Push taiga-async
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -t $REPO:async-${VERSION}-ci \
            -f docker/taiga-back/Dockerfile \
            taiga-back/ \
            --push

  build-taiga-front:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone taiga-front ${{ env.VERSION }}
        run: |
          git clone --depth 1 --branch $VERSION https://github.com/taigaio/taiga-front.git
          cd taiga-front
          docker buildx build \
            --platform linux/arm64 \
            -t $REPO:front-${VERSION}-ci \
            -f docker/Dockerfile . \
            --push

  build-taiga-events:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone taiga-events ${{ env.VERSION }}
        run: |
          git clone --depth 1 --branch $VERSION https://github.com/taigaio/taiga-events.git
          cd taiga-events
          docker buildx build \
            --platform linux/arm64 \
            -t $REPO:events-${VERSION}-ci \
            -f docker/Dockerfile . \
            --push

  build-taiga-protected:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone taiga-protected ${{ env.VERSION }}
        run: |
          git clone --depth 1 --branch $VERSION https://github.com/taigaio/taiga-protected.git
          docker buildx build \
            --platform linux/arm64 \
            -t $REPO:protected-${VERSION}-ci \
            -f docker/taiga-protected/Dockerfile \
            taiga-protected/ \
            --push

  test-and-push:
    runs-on: ubuntu-latest
    needs:
      [
        build-taiga-back-and-async,
        build-taiga-front,
        build-taiga-events,
        build-taiga-protected,
      ]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull CI images (ARM64)
       run: |
         docker pull --platform=linux/arm64 $REPO:back-${VERSION}-ci
         docker pull --platform=linux/arm64 $REPO:async-${VERSION}-ci
         docker pull --platform=linux/arm64 $REPO:front-${VERSION}-ci
         docker pull --platform=linux/arm64 $REPO:events-${VERSION}-ci
         docker pull --platform=linux/arm64 $REPO:protected-${VERSION}-ci

      - name: Retag as latest
        run: |
          docker tag $REPO:back-${VERSION}-ci $REPO:back-latest
          docker tag $REPO:async-${VERSION}-ci $REPO:async-latest
          docker tag $REPO:front-${VERSION}-ci $REPO:front-latest
          docker tag $REPO:events-${VERSION}-ci $REPO:events-latest
          docker tag $REPO:protected-${VERSION}-ci $REPO:protected-latest

      - name: Push latest tags
        run: |
          docker push $REPO:back-latest
          docker push $REPO:async-latest
          docker push $REPO:front-latest
          docker push $REPO:events-latest
          docker push $REPO:protected-latest
